<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testing Login Page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap" rel="stylesheet">

  </head>
  <body>
    <div class="d-flex justify-content-center align-items-center vh-100 flex-column">
      <div class="card shadow p-4" style="width: 360px;">
      <h3 class="text-center mb-4">Welcome to our Inventory System!</h3>
      <form action="" class="mx-auto" style="max-width: 360px;">
        <div class="mb-3">
          <div class="btn-group d-flex" role="group" aria-label="Role selection">
            <input type="radio" class="btn-check" name="role" id="roleEmployee" autocomplete="off" checked>
            <label class="btn btn-outline-primary flex-fill" for="roleEmployee">Employee</label>
            <input type="radio" class="btn-check" name="role" id="roleAdmin" autocomplete="off">
            <label class="btn btn-outline-primary flex-fill" for="roleAdmin">Admin</label>
          </div>
        </div>
        <div class="form-floating mb-3">
          <input type="text" class="form-control" id="floatingInput" placeholder="Username">
          <label for="floatingInput">Username</label>
        </div>
        <div class="form-floating mb-3">
          <input type="password" class="form-control" id="floatingPassword" placeholder="Password">
          <label for="floatingPassword">Password</label>
        </div>
        

        <div class="form-check mb-3">
          <input type="checkbox" class="form-check-input" id="rememberMe">
          <label class="form-check-label" for="rememberMe">Remember me</label>
        </div>
        
        <button type="submit" class="btn btn-primary w-100">Login</button>
        <a href="#" class="my-3 float-start">Forgot password?</a>
        <a href="#" class="my-3 float-end">Create an account</a>
      </form>
      </div>
      </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const form = document.querySelector('form');
        const usernameInput = document.getElementById('floatingInput');
        const passwordInput = document.getElementById('floatingPassword');
        const roleEmployee = document.getElementById('roleEmployee');
        const roleAdmin = document.getElementById('roleAdmin');

        form.setAttribute('novalidate', '');

        function showAlert(message, type) {
          const alertType = type || 'danger';
          let existing = document.getElementById('form-alert');
          if (!existing) {
            existing = document.createElement('div');
            existing.id = 'form-alert';
            existing.className = 'alert mt-3';
            form.parentElement.appendChild(existing);
          }
          existing.className = 'alert mt-3 alert-' + alertType;
          existing.textContent = message;
        }

        function clearAlert() {
          const existing = document.getElementById('form-alert');
          if (existing) existing.remove();
        }

        function setInvalid(input, message) {
          input.classList.add('is-invalid');
          const wrapper = input.closest('.form-floating') || input.parentElement;
          let feedback = wrapper.nextElementSibling && wrapper.nextElementSibling.classList && wrapper.nextElementSibling.classList.contains('invalid-feedback')
            ? wrapper.nextElementSibling
            : null;
          if (!feedback) {
            feedback = document.createElement('div');
            feedback.className = 'invalid-feedback d-block';
            wrapper.insertAdjacentElement('afterend', feedback);
          }
          feedback.textContent = message;
        }

        function clearInvalid(input) {
          input.classList.remove('is-invalid');
          const wrapper = input.closest('.form-floating') || input.parentElement;
          const next = wrapper.nextElementSibling;
          if (next && next.classList && next.classList.contains('invalid-feedback')) {
            next.remove();
          }
        }

        function getSelectedRole() {
          return roleAdmin && roleAdmin.checked ? 'Admin' : 'Employee';
        }

        form.addEventListener('submit', async function (event) {
          event.preventDefault();
          clearAlert();
          clearInvalid(usernameInput);
          clearInvalid(passwordInput);

          const username = usernameInput.value.trim();
          const password = passwordInput.value;

          let hasError = false;
          if (!username) { setInvalid(usernameInput, 'Username is required'); hasError = true; }
          if (!password) { setInvalid(passwordInput, 'Password is required'); hasError = true; }
          if (hasError) return;

          const submitButton = form.querySelector('button[type="submit"]');
          const originalText = submitButton ? submitButton.textContent : '';
          if (submitButton) { submitButton.disabled = true; submitButton.textContent = 'Signing in...'; }

          try {
            const response = await fetch('users.json', { cache: 'no-store' });
            if (!response.ok) throw new Error('Unable to load users');
            const users = await response.json();
            const role = getSelectedRole();
            const user = Array.isArray(users)
              ? users.find(function (u) { return u.username === username && u.password === password && u.role === role; })
              : null;
            if (!user) throw new Error('Invalid credentials');
            try {
              sessionStorage.setItem('isAuthenticated', 'true');
              sessionStorage.setItem('authUser', JSON.stringify({ username: user.username, role: user.role }));
              localStorage.setItem('isAuthenticated', 'true');
              localStorage.setItem('authUser', JSON.stringify({ username: user.username, role: user.role }));
            } catch (e) { /* ignore */ }
            
            window.location.href = 'data.html?ts=' + Date.now();
          } catch (err) {
            showAlert(err && err.message ? err.message : 'Login failed. Please try again.', 'danger');
          } finally {
            if (submitButton) { submitButton.disabled = false; submitButton.textContent = originalText; }
            passwordInput.value = '';
          }
        });
      });
    </script>
  </body>
</html>